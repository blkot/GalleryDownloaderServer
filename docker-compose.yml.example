services:
  api:
    build: .
    image: gallery-downloader-api:latest
    restart: unless-stopped
    environment:
      GDL_API_TOKEN: ${GDL_API_TOKEN:?err}
      GDL_REDIS_URL: ${GDL_REDIS_URL:?err}
      GDL_DATABASE_URL: ${GDL_DATABASE_URL:-sqlite:///data/gallery.db}
      GDL_STORAGE_ROOT: ${GDL_STORAGE_ROOT:-/downloads}
      GDL_GALLERY_DL_EXTRA_ARGS: ${GDL_GALLERY_DL_EXTRA_ARGS:-}
      GDL_JOB_TIMEOUT_SECONDS: ${GDL_JOB_TIMEOUT_SECONDS:-0}
    ports:
      - "8080:8080"
    volumes:
      - ./data:/data                           # gallery.db + runtime state
      - ./config/gallery-dl.json:/etc/gallery-dl/config.json:ro
      - /share/CACHEDEV2_DATA/Cars2/GDL:/downloads
    depends_on:
      - redis

  worker:
    build: .
    image: gallery-downloader-worker:latest
    entrypoint: ["python", "-m", "app.worker"]
    restart: unless-stopped
    environment:
      GDL_API_TOKEN: ${GDL_API_TOKEN:?err}
      GDL_REDIS_URL: ${GDL_REDIS_URL:?err}
      GDL_DATABASE_URL: ${GDL_DATABASE_URL:-sqlite:///data/gallery.db}
      GDL_STORAGE_ROOT: ${GDL_STORAGE_ROOT:-/downloads}
      GDL_GALLERY_DL_EXTRA_ARGS: ${GDL_GALLERY_DL_EXTRA_ARGS:-}
      GDL_JOB_TIMEOUT_SECONDS: ${GDL_JOB_TIMEOUT_SECONDS:-0}
    volumes:
      - ./data:/data
      - ./config/gallery-dl.json:/etc/gallery-dl/config.json:ro
      - /share/CACHEDEV2_DATA/Cars2/GDL:/downloads
    depends_on:
      - redis

  redis:
    image: redis:7-alpine
    container_name: gdl_redis
    restart: unless-stopped
    command: ["redis-server", "--save", "60", "1"]
    volumes:
      - ./redis-data:/data

